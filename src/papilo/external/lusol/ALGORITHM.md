# LUSOL アルゴリズムの概要

LUSOL (LU-Solver) は、大規模な疎行列 (sparse matrix) のLU分解を効率的に計算し、維持するためのソフトウェアパッケージです。特に、数理最適化のソルバー（例えばシンプレックス法を実装した線形計画ソルバー）の計算エンジンとして設計されています。

このドキュメントでは、LUSOLに実装されている主要なアルゴリズムについて解説します。

## 疎行列の保持形式

疎行列の効率的な処理は、非ゼロ要素をどのように格納しアクセスするかに大きく依存します。LUSOLは、この目的のために柔軟かつ高性能なデータ構造を採用しています。

### 入力形式: 座標形式 (Coordinate Format)

ユーザーがLUSOLに行列を渡す際は、**座標形式（COO）**または**三重対形式（Triplet Format）**と呼ばれる柔軟な形式を使用します。これは3つの配列で構成されます。

- `a(*)`: 非ゼロ要素の値 ($A_{ij}$)
- `indc(*)`: 対応する**行インデックス** ($i$)
- `indr(*)`: 対応する**列インデックス** ($j$)

この形式は、非ゼロ要素を任意の順序で指定できる利点があります。

### 内部形式: 列リストと行リストの併用

`lu1fac`サブルーチンは、分解処理の開始時に、入力された座標形式のデータを2つの内部データ構造に変換します。分解中は、これら両方のリストを同時にメモリ上に保持し、更新し続けます。

- **列リスト (Column List)**: これは **CSC (Compressed Sparse Column)** 形式と本質的に同じデータ構造です。列に対する高速なアクセス（特定の列の全要素を走査するなど）を可能にします。

- **行リスト (Row List)**: これは **CSR (Compressed Sparse Row)** 形式と本質的に同じデータ構造です。行に対する高速なアクセスを可能にします。

LUSOLがこれら2つの形式を同時に保持する理由は、**ピボット選択の高速化**にあります。Markowitz法のようなピボット戦略では、ピボット候補 `(i, j)` を評価するために、その時点での**行 `i` の非ゼロ要素数**と**列 `j` の非ゼロ要素数**の両方が必要となります。列リストと行リストを両方持つことで、LUSOLはこれらの情報を即座に取得でき、Markowitz法の探索を極めて効率的に実行することができます。

## 疎行列LU分解 (Sparse LU Factorization)

LUSOLの中核機能は、与えられた `m x n` の疎行列 $A$ を以下の形式に分解することです。

$$
P A Q = L U
$$

ここで、
- $P$ と $Q$ は、数値的安定性を保ち、分解後の行列の疎性を維持するために選択される置換行列 (permutation matrices) です。
- $L$ は下三角行列 (lower triangular matrix) です。
- $U$ は上三角行列 (upper triangular matrix) です。

この分解処理は、主に **`lu1fac`** サブルーチンによって実行されます。

### ピボット選択 (Pivoting)

LU分解の過程で、どの要素をピボット（対角要素）として選択するかは、計算の数値的安定性と、結果として得られるL, U行列の疎性（非ゼロ要素の数）に極めて大きな影響を与えます。LUSOLは、このトレードオフを管理するために、複数の洗練されたピボット選択戦略を実装しています。

- **Markowitz法:** ピボット候補の「Markowitzカウント」（`(r-1)*(c-1)`、ここで `r` と `c` はそれぞれピボット候補の行と列にある非ゼロ要素の数）を最小化することで、フィルイン（fill-in、つまり元はゼロだった要素が非ゼロになること）を局所的に最小化しようとします。
- **閾値ピボット法 (Threshold Pivoting):** 数値的安定性を確保するため、ピボット候補の大きさが、その行または列の最大要素に対して一定の閾値（threshold）を超えることを要求します。LUSOLは以下の戦略をサポートしています。
  - **TPP (Threshold Partial Pivoting):** 列内でのみピボット候補を探します。
  - **TRP (Threshold Rook Pivoting):** ピボット候補が行と列の両方で「比較的大きい」ことを要求します。
  - **TCP (Threshold Complete Pivoting):** 行列全体で最大の要素をピボットとして探す戦略に近いです。最も安定しますが、計算コストも高くなります。

## LU分解の更新 (LU Update)

LUSOLの最も強力な特徴の一つが、一度計算したLU分解を、元の行列 $A$ に加えられた変更に応じて効率的に**更新**する機能です。これにより、変更のたびにLU分解をゼロから計算し直すのに比べて、計算コストを劇的に削減できます。

この機能は、シンプレックス法のように、毎回の反復で基底行列の列が1本だけ入れ替わるようなアルゴリズムで不可欠です。

### 列の置換 (Column Replacement)

最も重要で頻繁に使用される更新操作は、行列の1つの列を新しいベクトルで置き換える操作です。この処理は **`lu8rpc`** (replace column) サブルーチンによって実装されています。

`lu8rpc` は、既存のLU分解と新しい列ベクトルを入力として受け取り、**Bartels-Golub更新**や**Forrest-Tomlin更新**といった高度なアルゴリズムを用いて、新しい行列に対応するLU分解を効率的に再計算します。

#### Bartels-Golub更新とForrest-Tomlin更新

これらの更新手法は、基底行列 $B$ の1列を入れ替えて生じる新しい行列 $B_{new}$ のLU分解を効率的に得るための、異なる思想に基づいたアプローチです。

- **Bartels-Golub Update (1969):** この手法は**数値的安定性**を最優先します。更新の過程で、必要に応じて行の入れ替え（ピボッティング）を行い、ピボット要素が小さくなるのを防ぎます。これにより計算の信頼性は高まりますが、行の入れ替えがフィルイン（fill-in）を誘発し、行列の疎性が失われやすいという短所があります。

- **Forrest-Tomlin Update (1972):** この手法は**疎性の維持（計算速度）**を最優先します。フィルインを最小限に抑えるため、行の入れ替えを行いません。その代わり、巧妙な方法で $L$ と $U$ の構造を直接更新します。これにより更新は非常に高速になりますが、ピボット選択を行わないため、数値的に不安定になる可能性があります。

現代のソルバーは、これら2つの手法（またはその改良版）を組み合わせ、速度と安定性のバランスを取るのが一般的です。LUSOLの `lu8rpc` は、これらの古典的で強力なアルゴリズムを基盤としています。

### その他の更新操作

LUSOLは、列置換以外にも様々な更新操作をサポートしています。

- **`lu8adc`**: 列の追加 (add column)
- **`lu8adr`**: 行の追加 (add row)
- **`lu8dlc`**: 列の削除 (delete column)
- **`lu8dlr`**: 行の削除 (delete row)

これらの `lu8*` シリーズのサブルーチン群が、LUSOLの動的な計算能力を支えています。

## 線形方程式系の求解 (Solving Linear Systems)

LU分解が得られれば、$Ax = b$ のような線形方程式系を効率的に解くことができます。この処理は **`lu6sol`** サブルーチンが担当します。

$PAQ=LU$ の関係から、方程式 $Ax=b$ は以下のように変形できます。

$$
(P^{-1}LUQ^{-1})x = b \implies LU(Q^{-1}x) = Pb
$$

ここで $z = Q^{-1}x$ とおくと、求解は以下の2ステップに分かれます。

- **前進代入 (Forward Substitution):** $Ly = Pb$ を解いて $y$ を求める。
- **後退代入 (Backward Substitution):** $Uz = y$ を解いて $z$ を求める。

最後に、$x = Qz$ によって元の解 $x$ が得られます。$L$ と $U$ は三角行列なので、前進代入および後退代入は非常に高速に計算できます。

## 実装の構成

LUSOLは、主にFortran 90で記述された数値計算コア (`lusol.f90`) と、それを外部のプログラム（C/C++など）から呼び出すためのC言語API (`clusol.h`, `clusol.c`) から構成されています。

| C API関数 | Fortran サブルーチン | 機能 |
| :--- | :--- | :--- |
| `clu1fac` | `lu1fac` | LU分解の実行 |
| `clu6sol` | `lu6sol` | 線形方程式系の求解 |
| `clu8rpc` | `lu8rpc` | 列の置換によるLU分解の更新 |
| ... | ... | ... |

この構造により、高性能なFortranの数値計算ライブラリを、Papiloのようなより高レベルのC++アプリケーションに容易に組み込むことが可能になっています。